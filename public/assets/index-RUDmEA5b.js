import{w as m,a0 as C,n as h,l as r,k as v,a5 as g,R as _,r as x,t as j,a9 as R,F as N,bG as L,Q as M}from"./index-CYYMkemY.js";import{u as P,f as A}from"./socket-Ct7_Ier6.js";import{M as k}from"./MessageBox-DVdEd1Lw.js";import"./DialogContentText-DIlckXhd.js";function S({chat:t,onClick:e,selected:n}){const{auth:p}=C();return console.log(t.messages[t.messages.length-1].user.id=="U000002"),h("div",{className:`flex flex-row py-4 px-6 rounded-lg cursor-pointer mt-4 duration-200  justify-between   items-center  border-b-2 gap-2 ${n?"bg-slate-100":""} 
         ${t.messages[t.messages.length-1].user.id=="U000002"}
        `,onClick:()=>e(t._id),children:[r("div",{className:"h-10 w-fit flex justify-between  aspect-square",onClick:()=>console.log(t),children:t.type==="private"?t.users.filter(i=>i._id!==p._id).map(i=>{const o=i.profilePic?v.defaults.baseURL+"/auth/user/image/"+i.profilePic:null;return o?r("img",{src:o,className:"rounded-full h-10 w-10",alt:"profile"},i._id):r(g,{className:" size-[30px] rounded-full border-2 text-gray-500 p-1 border-gray-500"},i._id)}):r(g,{className:"text-5xl rounded-full border-2 text-gray-500 p-1 border-gray-500"})}),h("div",{className:"w-full",children:[r("div",{className:"text-lg  sm:block ",children:t.type!=="private"?t.type:t.users.filter(i=>i._id!=p._id).map(i=>i.name).join(", ")}),h("div",{className:"text-xs",children:[t.messages[t.messages.length-1].message.substring(0,16)," ",t.messages[t.messages.length-1].message.length>20&&"..."]})]}),r("hr",{})]},`chat-user-manager-${t._id}`)}S.propTypes={chat:m.object,onClick:m.func,selected:m.bool};function $({chat:t,message:e}){var w,a,b;const n=new Date(e==null?void 0:e.createdAt),p=n.getTime()?n.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"now",i=`${v.defaults.baseURL}/chat/file/${e.file}`,{auth:o}=C(),f=((e==null?void 0:e.user._id)??(e==null?void 0:e.user))===o._id;return h("div",{className:`flex flex-col items-${f?"end":"start"} w-full`,children:[r("div",{className:"text-xs text-gray-500 self-center my-1",children:n.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})}),h("div",{className:`flex ${f?"flex-row":"flex-row-reverse"} items-center gap-x-2 w-full`,children:[(w=e==null?void 0:e.user)!=null&&w.profilePic?r("img",{src:`${v.defaults.baseURL}/auth/user/image/${(a=e==null?void 0:e.user)==null?void 0:a.profilePic}`,className:"object-cover h-8 w-8 rounded-full",alt:"Profile"}):r(g,{className:"h-8 w-8 rounded-full border-2 text-gray-500 p-1 border-gray-500"}),h("div",{className:`py-3 px-4 ${f?"bg-gray-200 text-zinc-800":"bg-blue-400 text-white"} rounded-lg max-w-[75%] flex flex-col space-y-1`,children:[!f&&t.type!=="private"&&r("p",{className:"text-xs font-semibold ",children:(b=e==null?void 0:e.user)==null?void 0:b.name}),r("p",{className:"text-sm break-words",children:e==null?void 0:e.message}),(e==null?void 0:e.type)==="image"&&(e==null?void 0:e.file)&&r("img",{src:i,className:"object-cover rounded-md mt-2",alt:"Attachment"}),(e==null?void 0:e.type)==="file"&&(e==null?void 0:e.file)&&r("a",{href:i,target:"_blank",rel:"noreferrer",className:"text-xs hover:underline",children:"Download"}),r("div",{children:r("i",{className:`text-[.7rem] Currentcolor ml-3 ${f?"bg-gray-200 text-zinc-800":"self-end"}`,children:p})})]})]})]})}$.propTypes={message:m.object.isRequired,chat:m.object.isRequired};function U({chat:t,setChat:e,chats:n,disabledMessageBox:p,handleSubmit:i}){var c,d,s;const[o,f]=_.useState(!1),[w,a]=x.useState(),b=new URLSearchParams(window.location.search),y=l=>{l?(e(l),f(u=>!0)):(f(u=>!1),e(null))};return x.useEffect(()=>{o?b.set("chat","true"):b.set("chat","false"),window.history.replaceState(null,"","?"+b.toString())},[o]),x.useEffect(()=>{var l;t&&a((l=n[t])==null?void 0:l.users[0].name)},[t]),x.useEffect(()=>{},[w]),r("div",{className:`relative  h-[60vh] max-sm:mb-16 max-sm:-mt-24 ${o&&"max-sm:-mt-36"} z-50   flex flex-col max-sm:h-fit  w-full max-w-7xl mx-auto rounded-lg `,children:h("div",{className:"   flex h-fit max-sm:flex-col overflow-hidden  bg-white",children:[o&&h("div",{className:"text-xl lg:hidden items-end border-t-2 border-b-2 py-3   gap-4 text-brand-primary ml-0 px-3 flex ",children:[r("img",{src:`${v.defaults.baseURL}/auth/user/image/${(c=n[t])==null?void 0:c.users[0].profilePic}`,className:"h-10 w-10 rounded-full",alt:"image"}),w&&w]}),r("div",{className:`flex flex-col pr-1 h-full md:w-2/5 border-r-2 ${o?"max-md:hidden":"max-md:w-screen"} overflow-y-scroll min-h-[70vh] gap-1`,children:Object.entries(n).map(([l,u])=>r(S,{selected:t===l,chat:u,onClick:()=>y(l)},l))}),h("div",{className:`flex flex-col max-sm:w-full h-[70vh] max-sm:mb-16 md:h-[67vh] z-[9999] ${o?"max-sm:w-[70vw]":"max-sm:hidden"}md:w-[70vw]`,children:[r("div",{className:"flex flex-col flex-grow gap-2  overflow-y-auto p-3 md:w-[50vw]",children:(s=(d=n==null?void 0:n[t])==null?void 0:d.messages)==null?void 0:s.map((l,u)=>r($,{message:l,chat:n[t]},`chat-message-${u}`))}),r("div",{className:`  max-sm:!fixed max-sm:bottom-0  ${o?"!z-[1000]":"hidden"}`,children:!p&&r("div",{className:"pl-3  justify-end items-center  flex z-[9999]",children:r(k,{disabled:p||!t,onSend:({message:l})=>i({chat:t,message:l}),toggleChat:y})})})]})]})})}U.propTypes={chat:m.string,setChat:m.func.isRequired,chats:m.object.isRequired,disabledMessageBox:m.bool,handleSubmit:m.func.isRequired};function F(){const t={private:{},system:{},broadcast:{}},[e,n]=x.useState(t),[p,i]=x.useState(),[o,f]=x.useState("chats"),{auth:w}=C(),a=P();j({queryKey:["chats",w._id],queryFn:async({signal:c})=>{const{data:d}=await v.get("/chat",{signal:c}),s=t;for(let l=0;l<d.length;l++){const u=d[l];s[u.type][u._id]=u}return n(s),d}}),x.useEffect(()=>(a.connect().emit("connection"),()=>{a.disconnect()}),[a]),x.useEffect(()=>{function c(s){console.log(s),n(l=>{const u=l[s.chat.type][s.chat._id];return u?(u.messages.push(s),{...l}):(l[s.chat.type][s.chat._id]={messages:[s]},{...l})})}function d({chat:s}){n(l=>(l[s.type][s._id]=s,{...l}))}return a.removeAllListeners("UpdateNewMessage"),a.removeAllListeners("UpdateNewChat"),a.on("UpdateNewMessage",c),a.on("UpdateNewChat",d),()=>{a.removeAllListeners("UpdateNewMessage"),a.removeAllListeners("UpdateNewChat")}},[a]);const b=async({message:c,chat:d})=>{if(!y(c)||!d)return;const s={chat:d,message:c};console.log(s),a.emit("sendMessage",s)};console.log(e);const y=c=>new RegExp(A.join("|"),"gi").test(c)?(M.error("Message contains inappropriate words!"),!1):!0;return r("div",{className:"max-sm:mt-3",children:h(L,{title:"Messages",className:"p-3",children:[r(R,{onTabChange:c=>{i(null),f(c)},navs:[{name:"Guest",view:"private",component:()=>r(N,{})},{name:"Broadcast",view:"broadcast",component:()=>r(N,{})},{name:"Admin",view:"system",component:()=>r(N,{})}]}),r(U,{chat:p,setChat:i,chats:e[o]??{},disabledMessageBox:o!=="private",handleSubmit:b})]})})}export{F as default};
